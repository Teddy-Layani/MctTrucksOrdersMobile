sap.ui.define(["com/meir/meirordersmobile/controller/BaseController","sap/ui/core/routing/History"],function(e,t){"use strict";return e.extend("com.meir.meirordersmobile.controller.MONewActivityDetails",{onInit:function(){var e=this.getRouter();e.getRoute("MONewActivityDetails").attachPatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(){var e=this.getOwnerComponent().getModel("moModel");this.ObjectId=e.getProperty("/MONewActivityDetails/currentActivityDetails/ObjectId");this.ObjectType=e.getProperty("/MONewActivityDetails/currentActivityDetails/ObjectType");this.sProcessType=e.getProperty("/MONewActivityDetails/currentActivityDetails/ProcessType");this.sGuid=e.getProperty("/MONewActivityDetails/currentActivityDetails/Guid");if(this.ObjectId&&this.ObjectType){this.getCurrentAttachments()}this.sProcessType=this.sProcessType?this.sProcessType:"ZPCT";e.setProperty("/MONewActivityDetails/currentActivityDetails/ProcessType",this.sProcessType);var t=e.getProperty("/MONewActivityDetails/currentActivityDetails/ActivityStatus");t=t?t:"E0010";e.setProperty("/MONewActivityDetails/currentActivityDetails/ActivityStatus",t);this.getActivityStatus(this.sProcessType,this.sGuid)},getActivityStatus:function(e,t){this.getView().setBusy(true);var i=[];if(t){i.push(new sap.ui.model.Filter("Guid","EQ",t))}else{i.push(new sap.ui.model.Filter("ProcessType","EQ",e))}var r=this;var s={filters:i,success:function(e){var t=r.getOwnerComponent().getModel("moModel");t.setProperty("/MONewActivityDetails/currentActivityDetails/ActivityStatusOptions",e.results);r.getView().setBusy(false)},error:function(e){r.getView().setBusy(false);r.error.processConnectionError(e,r)}};this.models.doRead(this,"/ProcessTypeStatusSet",s,true)},onStatusOppChange:function(e){var t=e.getSource().getSelectedKey();var i=this.getOwnerComponent().getModel("moModel");i.setProperty("/MONewActivityDetails/currentActivityDetails/ActivityStatus",t)},getActivityEntity:function(){this.getView().setBusy(true);var e=this.getOwnerComponent().getModel();var t=this;var i="/ActivitySet(guid'"+this.Guid+"')";e.read(i,{success:function(e){var i=t.getOwnerComponent().getModel("moModel");i.setProperty("/MONewActivityDetails/currentActivityDetails",e.results);t.getView().setBusy(false)},error:function(e){t.getView().setBusy(false)}})},getCurrentAttachments:function(){var e=[new sap.ui.model.Filter("ObjectId","EQ",this.ObjectId),new sap.ui.model.Filter("ObjectType","EQ",this.ObjectType)];var t=this;var i={filters:e,success:function(e){var i=t.getOwnerComponent().getModel("moModel");i.setProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet",e.results);t.getView().setBusy(false)}};this.models.doRead(this,"/AttachmentSet",i,true)},getIconType:function(e){if(e==="1"){return"css/icons/imageIcon.svg"}else if(e==="2"){return"css/icons/music_note_black.svg"}return"css/icons/article_black_icon.svg"},getAttachmentType:function(e){var t=["JPG","JPEG","jpeg","jpg","PNG","png"];if(t.includes(e)){return"1"}return"99"},onNavigatePressReturn:function(){var e=t.getInstance();var i=e.getPreviousHash();if(i){window.history.go(-1)}else{this.getRouter().navTo("overview",true)}},handleUpload:function(e){var t=this.getGlobalModel("moModel");var i=t.getProperty("/MONewActivityDetails/currentActivityDetails");var r=this.getOwnerComponent().getModel("moModel");var s=this;var o=e.getSource();var a=o.getFocusDomRef();var n=a.files[0];var c=o.getProperty("value");var l=c.split(".").pop();var u=this.getAttachmentType(l);var d=t.getProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet");d=d?d:[];var g=new FileReader;g.onload=function(e){var i=e.currentTarget.result.split(",")[1];d.push({ObjectId:this.ObjectId?this.ObjectId:null,ObjectType:this.ObjectType?this.ObjectType:null,FileName:c,AttachmentType:u,FileContent:i,isNew:true});t.setProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet",d)};g.readAsDataURL(n)},createNewActivity:function(){var e=this;this.getView().setBusy(true);var t=this.getOwnerComponent().getModel();var i=this.getGlobalModel("moModel").getProperty("/MONewActivityDetails/currentActivityDetails");var r={Partner:i.Partner,OppObjectId:i.OppObjectId,Date:i.Date,Comments:i.Comments,ProcessType:i.ProcessType,Status:i.ActivityStatus};if(i.Guid){r.Guid=i.Guid;r.Time=i.Time}else{var s=i.Time;var o=s.split(":");var a="PT"+o[0]+"H"+o[1]+"M00S";r.Time=a}var n=this.getGlobalModel("moModel");var c=n.getProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet");var l=false;c=c?c:[];for(var u=0,d=c.length;u<d;u++){if(c[u].isNew){l=true;break}}var g={success:function(t){e.getView().setBusy(false);if(l){e.saveAttachments(t)}else{e.onOpenSaveDialog()}}};this.models.doCreate(this,"/ActivitySet",r,g,true)},saveAttachments:function(e){var t=e.ObjectId;var i=e.ObjectType;var r=this.getGlobalModel("moModel");var s=r.getProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet");var o=this;this._nCounter=0;this._nNewAttachments=0;s.forEach(function(e,s){if(e.isNew){o._nNewAttachments++;var a={success:function(e){r.setProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet/"+s+"/isNew",false);o._nCounter++;if(o._nNewAttachments===o._nCounter){o.onOpenSaveDialog()}}};var n=JSON.parse(JSON.stringify(e));delete n.isNew;n.ObjectId=t;n.ObjectType=i;o.models.doCreate(o,"/AttachmentSet",n,a,true)}})},onOpenSaveDialog:function(){var e=null;if(!sap.ui.getCore().byId("saveDetailsDialog")){e=sap.ui.xmlfragment("com.meir.meirordersmobile.view.saveDetailsDialog",this);this.getView().addDependent(e)}else{e=sap.ui.getCore().byId("saveDetailsDialog")}if(!e.isOpen()){e.open()}},onCloseDialog:function(){sap.ui.getCore().byId("saveDetailsDialog").close();this.onNavHome()},onOpenRecordDialog:function(){var e=null;if(!sap.ui.getCore().byId("RecordAudioDialog")){e=sap.ui.xmlfragment("com.meir.meirordersmobile.view.RecordAudioDialog",this);this.getView().addDependent(e)}else{e=sap.ui.getCore().byId("RecordAudioDialog")}if(!e.isOpen()){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle();sap.ui.getCore().byId("toggleRecordBtn").setText(t.getText("recording"));e.open()}},onCloseRecordDialog:function(){sap.ui.getCore().byId("RecordAudioDialog").close();sap.ui.getCore().byId("toggleRecordBtn").setVisible(true);sap.ui.getCore().byId("playRecordingBtn").setVisible(false);sap.ui.getCore().byId("deleteRecordingBtn").setVisible(false);sap.ui.getCore().byId("sevaRecordingBtn").setVisible(false)},stream:{},blobs:[],oFileAudioData:{ObjectId:"",ObjectType:"",FileName:"",AttachmentType:"",FileContent:""},recorderBlob:{},onToggleRecording:async function(e){if(e.getSource().getPressed()){var t=this.getOwnerComponent().getModel("i18n").getResourceBundle();e.getSource().setText(t.getText("stopRecording"));this.stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});this.mediaRecorder=new window.MediaRecorder(this.stream);this.mediaRecorder.ondataavailable=function(e){this.blobs.push(e.data)}.bind(this);this.mediaRecorder.onstop=function(e){this.recorderBlob=new Blob(this.blobs,{type:this.mediaRecorder.mimeType});var t=new Date;this.blobs=[];var i=t.getDate()+"_"+t.getMonth()+"_"+t.getYear();var r=t.getHours()+"_"+t.getMinutes();var s="recording "+i+" "+r+".webm";this.oFileAudioData={ObjectId:this.ObjectId,ObjectType:this.ObjectType,FileName:s,AttachmentType:"2",FileContent:""}}.bind(this);this.mediaRecorder.start()}else{this.mediaRecorder.stop();this.stream.getTracks().forEach(function(e){e.stop()});sap.ui.getCore().byId("toggleRecordBtn").setVisible(false);sap.ui.getCore().byId("playRecordingBtn").setVisible(true);sap.ui.getCore().byId("deleteRecordingBtn").setVisible(true);sap.ui.getCore().byId("sevaRecordingBtn").setVisible(true)}},onPlayRecording:function(){var e=window.URL.createObjectURL(this.recorderBlob);var t=new Audio(e);t.play()},onDeleteRecording:function(){this.oFileAudioData={ObjectId:"",ObjectType:"",FileName:"",AttachmentType:"2",FileContent:""};this.onCloseRecordDialog()},onSaveRecording:function(){var e=this.getOwnerComponent().getModel("moModel");var t=this;var i=this.getGlobalModel("moModel").getProperty("/MONewActivityDetails/currentActivityDetails");var r=e.getProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet");r=r?r:[];var s=new FileReader;s.onload=function(i){var s=new Date;var o=s.getDate()+"_"+s.getMonth()+"_"+s.getYear();var a=s.getHours()+"_"+s.getMinutes();var n="recording "+o+" "+a+".webm";var c=i.currentTarget.result.split(",")[1];r.push({ObjectId:t.ObjectId?t.ObjectId:null,ObjectType:t.ObjectType?t.ObjectType:null,FileName:n,AttachmentType:"2",FileContent:c,isNew:true});e.setProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet",r);t.onCloseRecordDialog()};s.readAsDataURL(t.recorderBlob)},onPlaySaveRecording:async function(e){var t=e.getSource();if(e.getSource().getPressed()){var i=e.getSource().data("attachmentDetails");var r=await fetch("data:audio/webm;base64,"+i.FileContent);var s=await r.blob();var o=window.URL.createObjectURL(s);this.oAudioFile=new Audio(o);t.setIcon("css/icons/icons8-pause-30.png");this.oAudioFile.play()}else{t.setIcon("css/icons/play_circle_black.svg");this.oAudioFile.pause()}},onViewDoc:async function(e){console.log("on play function");var t=e.getSource().data("attachmentDetails");var i=t.FileName;var r=i.split(".").pop();var s;if(t.AttachmentType==="1"){s="data:image/"+r+";base64,"}else{s="data:application/"+r+";base64,"}var o=t.FileContent;var a=document.createElement("a");a.download=encodeURI("document."+r.toLowerCase());a.href=s+o;a.click()},onDeleteAttachment:function(e){var t=e.getSource().getBindingContext("moModel").getPath();var i=parseFloat(t.split("/").pop());var r=this.getOwnerComponent().getModel("moModel");var s=r.getProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet");s.splice(i,1);r.setProperty("/MONewActivityDetails/currentActivityDetails/CurrentAttachmentsSet",s)}})});